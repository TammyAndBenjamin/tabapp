{% extends 'layout.html' %}

{% block content %}
    <h1>Products costs</h1>
    <table id="sales" class="table table-condensed">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Cost</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
                <tr class="action_row" data-product-id="{{ product.id }}" data-label="{{ product.title }}" data-value="{{ product.cost if product.cost != None else '' }}">
                    <td>{{ product.title }}</td>
                    <td>{{ product.price }}</td>
                    <td>{{ product.cost if product.cost != None else 'No cost' }}{% if product.cost %}&nbsp;<span class="glyphicon glyphicon-search cost_lookback"></span>{% endif %}</td>
                    <td><a class="edit_cost">Edit</a></td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <ul id="pager" class="pagination">
        <li{% if page == 1 %} class="disabled"{% endif %}><a href="{{ url_for('product_costs_bp.products_list') }}?page={{ page - 1 }}">&laquo;</a></li>
        {% for i in range(0, max_page) %}
            {% set real_i = i + 1 %}
            <li{% if page == real_i %} class="active"{% endif %}><a href="{{ url_for('product_costs_bp.products_list') }}?page={{ real_i }}">{{ real_i }}</a></li>
        {% endfor %}
        <li{% if page == max_page %} class="disabled"{% endif %}><a href="{{ url_for('product_costs_bp.products_list') }}?page={{ page + 1 }}">&raquo;</a></li>
    </ul>
    <div id="product_cost_modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Edit product cost</h4>
                </div>
                <div class="modal-body">
                    <form id="cost_form" role="form">
                        <div class="form-group">
                            <label for="product_cost">Product cost</label>
                            <input type="text" class="form-control" id="product_cost" name="product_cost">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary validate_cost">Save changes</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block script %}
    <script>
        (function($) {
            $('.cost_lookback').popover({
                trigger: 'manual',
                title: 'Costs history'
            });
            $('.action_row').on('click', '.cost_lookback', function(e) {
                var self = $(this),
                    row = $(e.delegateTarget);
                if (self.data('content')) {
                    return;
                }
                $.ajax({
                    type: 'GET',
                    url: '/products/' + row.data('product-id'),
                    success: function(response) {
                        var costs = response.costs;
                        self.attr('data-content', JSON.stringify(costs));
                        self.popover('show');
                    }
                });
            });
            $('.action_row').on('click', '.edit_cost', function(e) {
                var self = $(e.delegateTarget);
                $('#cost_form')
                    .attr('action', '/products/' + self.data('product-id'))
                    .find('label').html(self.data('label')).end()
                    .find('[name=product_cost]').val(self.data('value')).end();
                $('#product_cost_modal').modal('show');
            });
            $('#product_cost_modal .validate_cost').on('click', function(e) {
                var self = $(this),
                    form = $('#cost_form'),
                    data = form.serialize();
                $.ajax({
                    type: 'POST',
                    url: form.attr('action'),
                    data: data,
                    success: function(response) {
                    }
                });
            });
            $('#pager').on('click', 'a', function(e) {
                var self = $(this);
                self.attr('href', self.attr('href') + window.location.search);
            });
        })(jQuery);
    </script>
{% endblock script %}
